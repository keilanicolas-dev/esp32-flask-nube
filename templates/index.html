<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo ESP32 en la nube</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0e0f10;
      --card:#1a1c1f;
      --cyan:#11c5d9;
      --txt:#e9eef2;
      --muted:#aab6be;
      --btn:#22262a;
      --btnActive:#0fb9cc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 500px at 50% -100px, rgba(17,197,217,.25), transparent 60%), var(--bg);
      color:var(--txt);
      text-align:center;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:24px 14px 40px}
    h1{
      margin:10px 0 6px;
      font-weight:800;
      letter-spacing:.5px;
      color:var(--cyan);
      text-shadow:0 0 24px rgba(17,197,217,.25);
    }
    .sub{color:var(--muted);margin:0 0 18px}
    .topbar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:14px 0 18px;
    }
    .btn{
      border:none;
      padding:10px 16px;
      border-radius:12px;
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      transition:transform .08s ease, background .15s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.active{background:var(--btnActive); color:#001014}
    .btn.csv{
      background:linear-gradient(135deg, rgba(17,197,217,.95), rgba(17,197,217,.75));
      color:#001014;
    }
    .cards{
      margin-top:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      padding:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.45);
    }
    .tab{display:none}
    .tab.active{display:block}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
    }
    .card{
      background: radial-gradient(900px 320px at 50% 0px, rgba(255,255,255,.06), transparent 65%), var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      padding:16px 14px 10px;
    }
    .card h2{
      margin:8px 0 8px;
      font-size:20px;
      font-weight:800;
    }
    canvas{width:100% !important; height:320px !important;}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Monitoreo ESP32 en la nube</h1>
    <p class="sub">Registros: <span id="count">0</span></p>

    <div class="topbar">
      <button class="btn active" data-tab="tTemp">Temperatura (掳C)</button>
      <button class="btn" data-tab="tSens">Sensores 1</button>
      <button class="btn" data-tab="tRad">Radi贸metro</button>
      <button class="btn csv" id="btnCSV"> Descargar CSV</button>
    </div>

    <div class="cards">
      <div id="tTemp" class="tab active">
        <div class="card">
          <h2>Temperatura (掳C)</h2>
          <canvas id="chTemp"></canvas>
          <div class="hint">Tip: pasa el dedo/rat贸n sobre la l铆nea para ver el valor.</div>
        </div>
      </div>

      <div id="tSens" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje (V)</h2>
            <canvas id="chVolt"></canvas>
          </div>
          <div class="card">
            <h2>Corriente (A)</h2>
            <canvas id="chCorr"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia (W)</h2>
          <canvas id="chPot"></canvas>
        </div>
      </div>

      <div id="tRad" class="tab">
        <div class="card">
          <h2>Radi贸metro</h2>
          <canvas id="chRad"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
  // =======================
  // CONFIG
  // =======================
  const API_URL = "/api/data";
  const REFRESH_MS = 3000;

  // Ventana visible para evitar saturaci贸n
  const MAX_POINTS = 120;

  // Zona horaria correcta
  const TZ = "America/Mexico_City";

  // =======================
  // TABS
  // =======================
  const tabBtns = document.querySelectorAll(".btn[data-tab]");
  const tabs = document.querySelectorAll(".tab");
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      tabs.forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  // =======================
  // CHART FACTORY
  // =======================
  function makeLineChart(canvasId, label, suggestedMax){
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label,
          data: [],
          borderWidth: 2,
          pointRadius: 0,         // fluido + no saturaci贸n
          tension: 0.25,
          fill: false
        }]
      },
      options: {
        responsive: true,
        animation: false,         //  clave para rendimiento
        normalized: true,
        parsing: false,
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true, mode:"nearest", intersect:false },
          decimation: { enabled: true, algorithm: "min-max" }
        },
        scales: {
          x: {
            ticks: { autoSkip: true, maxRotation: 0 },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            suggestedMax,
            grid: { color: "rgba(255,255,255,.06)" }
          }
        }
      }
    });
  }

  const chTemp = makeLineChart("chTemp", "Temperatura (掳C)", 120);
  const chVolt = makeLineChart("chVolt", "Voltaje (V)", 30);
  const chCorr = makeLineChart("chCorr", "Corriente (A)", 10);
  const chPot  = makeLineChart("chPot",  "Potencia (W)", 200);
  const chRad  = makeLineChart("chRad",  "Radi贸metro", 4096);

  // =======================
  // HELPERS
  // =======================
  function safeNum(x){
  if (x === null || x === undefined) return null;
  if (x === "") return null;

  // Si viene como texto, arregla coma decimal y espacios
  if (typeof x === "string"){
    x = x.trim().replace(",", ".");
    if (x.toLowerCase() === "none" || x.toLowerCase() === "null") return null;
  }

  const n = parseFloat(x);
  return Number.isFinite(n) ? n : null;
}

  // Convierte fecha+hora (UTC del server) -> Date UTC
  function parseUTC(row){
    const h = (row.hora || "00:00:00").split(".")[0];
    //  Z = tratarlo como UTC
    return new Date(`${row.fecha}T${h}Z`);
  }

  // Etiqueta en hora local (M茅xico)
  const fmtTime = new Intl.DateTimeFormat("es-MX", {
    timeZone: TZ,
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit"
  });

  function labelLocal(row){
    return fmtTime.format(parseUTC(row));
  }

  function keepWindow(chart){
    const L = chart.data.labels.length;
    if (L > MAX_POINTS){
      const extra = L - MAX_POINTS;
      chart.data.labels.splice(0, extra);
      chart.data.datasets[0].data.splice(0, extra);
    }
  }

  function pushPoint(chart, label, value){
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);
    keepWindow(chart);
  }

  // =======================
  // CARGA INICIAL + UPDATE INCREMENTAL
  // =======================
  let lastId = 0; // vamos a ir agregando solo lo nuevo

  async function fetchAll(){
    const res = await fetch(API_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("API error " + res.status);
    const arr = await res.json();

    // En tu API ya aparecen id. Ordenamos por id asc
    arr.sort((a,b) => (a.id ?? 0) - (b.id ?? 0));
    return arr;
  }

  function redrawFromScratch(rows){
    // Limpia y dibuja SOLO la ventana final
    const view = rows.slice(-MAX_POINTS);

    for (const ch of [chTemp,chVolt,chCorr,chPot,chRad]){
      ch.data.labels = [];
      ch.data.datasets[0].data = [];
    }

    for (const r of view){
      const lab = labelLocal(r);
      pushPoint(chTemp, lab, safeNum(r.temperatura));
      pushPoint(chVolt, lab, safeNum(r.voltaje));
      pushPoint(chCorr, lab, safeNum(r.corriente));
      pushPoint(chPot,  lab, safeNum(r.potencia));
      pushPoint(chRad,  lab, safeNum(r.radiometro));
    }

    // Render r谩pido
    chTemp.update("none");
    chVolt.update("none");
    chCorr.update("none");
    chPot.update("none");
    chRad.update("none");

    // lastId al final
    if (rows.length){
      lastId = rows[rows.length - 1].id ?? lastId;
    }
  }

  async function refresh(){
    try{
      const rows = await fetchAll();
      document.getElementById("count").textContent = rows.length;

      if (!rows.length) return;

      // Primera vez: dibuja desde cero
      if (lastId === 0){
        redrawFromScratch(rows);
        return;
      }

      // Toma solo los nuevos
      const nuevos = rows.filter(r => (r.id ?? 0) > lastId);

      // Si no hay nuevos, nada que hacer
      if (!nuevos.length) return;

      // Agrega punto por punto (sin redibujar todo)
      for (const r of nuevos){
        const lab = labelLocal(r);
        pushPoint(chTemp, lab, safeNum(r.temperatura));
        pushPoint(chVolt, lab, safeNum(r.voltaje));
        pushPoint(chCorr, lab, safeNum(r.corriente));
        pushPoint(chPot,  lab, safeNum(r.potencia));
        pushPoint(chRad,  lab, safeNum(r.radiometro));
        lastId = r.id ?? lastId;
      }

      // Actualiza una sola vez cada chart
      chTemp.update("none");
      chVolt.update("none");
      chCorr.update("none");
      chPot.update("none");
      chRad.update("none");

    }catch(e){
      console.log("refresh error:", e);
    }
  }

  // =======================
  // CSV
  // =======================
  function pad2(n){ return String(n).padStart(2,"0"); }

  function toCSV(rows){
    const header = ["fecha","hora_local_mx","voltaje","corriente","potencia","radiometro","temperatura"];
    const lines = [header.join(",")];
    for(const r of rows){
      lines.push([
        r.fecha ?? "",
        labelLocal(r),
        r.voltaje ?? "",
        r.corriente ?? "",
        r.potencia ?? "",
        r.radiometro ?? "",
        r.temperatura ?? ""
      ].join(","));
    }
    return lines.join("\n");
  }

  document.getElementById("btnCSV").addEventListener("click", async () => {
    const rows = await fetchAll();
    const csv = toCSV(rows);

    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    const now = new Date();
    a.download = `esp32_${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}_${pad2(now.getHours())}${pad2(now.getMinutes())}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // =======================
  // START
  // =======================
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
