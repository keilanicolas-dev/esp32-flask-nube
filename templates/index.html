<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Monitoreo ESP32 en la nube</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#ffffff;
  --card:#e1e5ea;
  --cyan:#0b6cff;
  --txt:#1a1a1a;
  --muted:#5f6b76;
  --btn:#e6e9ed;
  --btnActive:#0b6cff;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
  background: var(--bg);
  color:var(--txt);
  text-align:center;
}

.wrap{
  max-width:1200px;
  margin:0 auto;
  padding:24px 14px 40px;
}

h1{
  margin:10px 0 6px;
  font-weight:800;
  color:var(--cyan);
}

.topbar{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:10px;
  margin:16px 0;
}

.btn{
  border:none;
  padding:10px 16px;
  border-radius:12px;
  background:var(--btn);
  color:var(--txt);
  cursor:pointer;
  font-weight:700;
}

.btn.active{
  background:var(--btnActive);
  color:#fff;
}

.cards{
  margin-top:10px;
  background:#f7f9fb;
  border-radius:22px;
  padding:18px;
}

.tab{display:none}
.tab.active{display:block}

.grid2{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:14px;
}

@media (max-width:900px){
  .grid2{grid-template-columns:1fr}
}

.card{
  background:var(--card);
  border-radius:22px;
  padding:16px;
}

.card h2{
  margin:6px 0 10px;
  font-size:18px;
}

canvas{
  width:100% !important;
  height:320px !important;
  background:#dde2e8;
  border-radius:12px;
}
</style>
</head>

<body>
<div class="wrap">
<h1>Monitoreo ESP32 en la nube</h1>

<div class="topbar">
  <button class="btn active" data-tab="tTemp">Temperatura</button>
  <button class="btn" data-tab="tSens">Sensores de paneles</button>
  <button class="btn" data-tab="tRad">Radiómetro</button>
  <button class="btn" data-tab="tW1">WROOM 1</button>
  <button class="btn" data-tab="tW2">WROOM 2</button>
  <button class="btn" data-tab="tW3">WROOM 3</button>
</div>

<div class="cards">

<!-- TEMPERATURA -->
<div id="tTemp" class="tab active">
  <div class="card">
    <h2>Temperatura (°C)</h2>
    <canvas id="chTemp"></canvas>
  </div>
</div>

<!-- S2 -->
<div id="tSens" class="tab">
  <div class="grid2">
    <div class="card"><h2>Voltaje</h2><canvas id="chVolt"></canvas></div>
    <div class="card"><h2>Corriente</h2><canvas id="chCorr"></canvas></div>
  </div>
  <div style="height:14px"></div>
  <div class="card"><h2>Potencia</h2><canvas id="chPot"></canvas></div>
</div>

<!-- RADIÓMETRO -->
<div id="tRad" class="tab">
  <div class="card">
    <h2>Radiómetro</h2>
    <canvas id="chRad"></canvas>
  </div>
</div>

<!-- WROOM 1 -->
<div id="tW1" class="tab">
  <div class="grid2">
    <div class="card"><h2>Voltaje 1</h2><canvas id="chWv1"></canvas></div>
    <div class="card"><h2>Corriente 1</h2><canvas id="chWc1"></canvas></div>
  </div>
  <div style="height:14px"></div>
  <div class="card"><h2>Potencia 1</h2><canvas id="chWp1"></canvas></div>
</div>

<!-- WROOM 2 -->
<div id="tW2" class="tab">
  <div class="grid2">
    <div class="card"><h2>Voltaje 2</h2><canvas id="chWv2"></canvas></div>
    <div class="card"><h2>Corriente 2</h2><canvas id="chWc2"></canvas></div>
  </div>
  <div style="height:14px"></div>
  <div class="card"><h2>Potencia 2</h2><canvas id="chWp2"></canvas></div>
</div>

<!-- WROOM 3 -->
<div id="tW3" class="tab">
  <div class="grid2">
    <div class="card"><h2>Voltaje 3</h2><canvas id="chWv3"></canvas></div>
    <div class="card"><h2>Corriente 3</h2><canvas id="chWc3"></canvas></div>
  </div>
  <div style="height:14px"></div>
  <div class="card"><h2>Potencia 3</h2><canvas id="chWp3"></canvas></div>
</div>

</div>
</div>

<script>
const MAX = 120;
const REFRESH = 3000;

function makeChart(id,label,maxY){
  return new Chart(document.getElementById(id),{
    type:"line",
    data:{labels:[],datasets:[{
      label,
      data:[],
      borderColor:"#0b6cff",
      borderWidth:2.5,
      pointRadius:0,
      tension:.25
    }]},
    options:{
      animation:false,
      scales:{
        x:{grid:{display:false}},
        y:{beginAtZero:true,suggestedMax:maxY,grid:{color:"rgba(0,0,0,.08)"}}
      }
    }
  });
}

const chTemp=makeChart("chTemp","Temp",120);
const chVolt=makeChart("chVolt","Voltaje",30);
const chCorr=makeChart("chCorr","Corriente",10);
const chPot =makeChart("chPot","Potencia",200);
const chRad =makeChart("chRad","Rad",4096);

const chWv1=makeChart("chWv1","V1",30);
const chWc1=makeChart("chWc1","C1",10);
const chWp1=makeChart("chWp1","P1",200);

const chWv2=makeChart("chWv2","V2",30);
const chWc2=makeChart("chWc2","C2",10);
const chWp2=makeChart("chWp2","P2",200);

const chWv3=makeChart("chWv3","V3",30);
const chWc3=makeChart("chWc3","C3",10);
const chWp3=makeChart("chWp3","P3",200);

async function refresh(){
  const s2 = await fetch("/api/data?device=s2").then(r=>r.json());
  const w  = await fetch("/api/data?device=wroom").then(r=>r.json());

  s2.sort((a,b)=>a.id-b.id);
  w.sort((a,b)=>a.id-b.id);

  const s = s2.slice(-MAX);
  const wv= w.slice(-MAX);

  const labelsS=s.map(d=>d.hora);
  const labelsW=wv.map(d=>d.hora);

  chTemp.data.labels=labelsS;
  chTemp.data.datasets[0].data=s.map(d=>d.temperatura);
  chTemp.update();

  chVolt.data.labels=labelsS;
  chVolt.data.datasets[0].data=s.map(d=>d.voltaje);
  chVolt.update();

  chCorr.data.labels=labelsS;
  chCorr.data.datasets[0].data=s.map(d=>d.corriente);
  chCorr.update();

  chPot.data.labels=labelsS;
  chPot.data.datasets[0].data=s.map(d=>d.potencia);
  chPot.update();

  chRad.data.labels=labelsS;
  chRad.data.datasets[0].data=s.map(d=>d.radiometro);
  chRad.update();

  chWv1.data.labels=labelsW; chWv1.data.datasets[0].data=wv.map(d=>d.voltaje1); chWv1.update();
  chWc1.data.labels=labelsW; chWc1.data.datasets[0].data=wv.map(d=>d.corriente1); chWc1.update();
  chWp1.data.labels=labelsW; chWp1.data.datasets[0].data=wv.map(d=>d.potencia1); chWp1.update();

  chWv2.data.labels=labelsW; chWv2.data.datasets[0].data=wv.map(d=>d.voltaje2); chWv2.update();
  chWc2.data.labels=labelsW; chWc2.data.datasets[0].data=wv.map(d=>d.corriente2); chWc2.update();
  chWp2.data.labels=labelsW; chWp2.data.datasets[0].data=wv.map(d=>d.potencia2); chWp2.update();

  chWv3.data.labels=labelsW; chWv3.data.datasets[0].data=wv.map(d=>d.voltaje3); chWv3.update();
  chWc3.data.labels=labelsW; chWc3.data.datasets[0].data=wv.map(d=>d.corriente3); chWc3.update();
  chWp3.data.labels=labelsW; chWp3.data.datasets[0].data=wv.map(d=>d.potencia3); chWp3.update();
}

document.querySelectorAll(".btn[data-tab]").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll(".btn").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    b.classList.add("active");
    document.getElementById(b.dataset.tab).classList.add("active");
  }
});

refresh();
setInterval(refresh,REFRESH);
</script>
</body>
</html>
