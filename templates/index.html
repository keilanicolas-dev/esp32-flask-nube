<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Monitoreo ESP32 en la nube</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0f0f10;
      --panel:#1b1b1e;
      --panel2:#151517;
      --txt:#e8e8ea;
      --muted:#b7b7bb;
      --accent:#00bcd4;
      --accent2:#0ea5b7;
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius: 18px;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1200px 600px at 50% -150px, #2a2a2e 0%, var(--bg) 45%, #0b0b0c 100%);
      color: var(--txt);
      text-align:center;
    }

    header{
      padding: 28px 16px 12px;
    }

    h1{
      margin:0;
      font-size: clamp(24px, 3.2vw, 38px);
      color: var(--accent);
      letter-spacing:.2px;
      text-shadow: 0 0 18px rgba(0,188,212,.18);
    }

    .sub{
      margin-top: 6px;
      color: var(--muted);
      font-size: 14px;
    }

    .topbar{
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
      padding: 14px 12px 10px;
    }

    .btn{
      border: none;
      cursor:pointer;
      padding: 10px 16px;
      border-radius: 12px;
      background: #26262a;
      color: var(--txt);
      font-weight: 600;
      transition: transform .08s ease, background .2s ease, opacity .2s ease;
    }
    .btn:hover{ opacity:.95; }
    .btn:active{ transform: translateY(1px); }

    .btn.active{
      background: linear-gradient(180deg, var(--accent) 0%, var(--accent2) 100%);
      color:#061316;
      box-shadow: 0 10px 22px rgba(0,188,212,.18);
    }

    .btn.download{
      background: linear-gradient(180deg, #00c2df 0%, #009eb5 100%);
      color:#061316;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 14px 28px;
    }

    .card{
      background: radial-gradient(900px 300px at 50% 0px, #2a2a2f 0%, var(--panel) 45%, var(--panel2) 100%);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 16px;
      margin: 14px auto 0;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 850px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .chartBox{
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(255,255,255,.06);
    }

    .chartTitle{
      margin: 6px 0 10px;
      font-size: 18px;
      font-weight: 800;
      color: #eaeaec;
    }

    canvas{
      width: 100% !important;
      height: 320px !important;
    }

    .hint{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }

    .tab{ display:none; }
    .tab.active{ display:block; }
  </style>
</head>

<body>
  <header>
    <h1>游댨 Monitoreo ESP32 en la nube</h1>
    <div class="sub">Registros: <span id="regCount">0</span></div>

    <div class="topbar">
      <button class="btn active" id="btnTemp" onclick="showTab('temp', this)">Temperatura (춿C)</button>
      <button class="btn" id="btnSens" onclick="showTab('sens', this)">Sensores 1</button>
      <button class="btn" id="btnRad"  onclick="showTab('rad', this)">Radi칩metro</button>

      <button class="btn download" onclick="downloadCSV()">
        游닌 Descargar CSV
      </button>
    </div>
  </header>

  <div class="wrap">
    <!-- TAB TEMPERATURA -->
    <div class="tab active" id="temp">
      <div class="card">
        <div class="chartBox">
          <div class="chartTitle">Temperatura (춿C)</div>
          <canvas id="cTemp"></canvas>
          <div class="hint">Tip: pasa el dedo/rat칩n sobre la l칤nea para ver el valor.</div>
        </div>
      </div>
    </div>

    <!-- TAB SENSORES -->
    <div class="tab" id="sens">
      <div class="card">
        <div class="grid2">
          <div class="chartBox">
            <div class="chartTitle">Voltaje (V)</div>
            <canvas id="cVolt"></canvas>
          </div>
          <div class="chartBox">
            <div class="chartTitle">Corriente (A)</div>
            <canvas id="cCorr"></canvas>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="chartBox">
          <div class="chartTitle">Potencia (W)</div>
          <canvas id="cPot"></canvas>
        </div>

        <div class="hint">Se muestran solo los 칰ltimos puntos para que no se sature.</div>
      </div>
    </div>

    <!-- TAB RADI칍METRO -->
    <div class="tab" id="rad">
      <div class="card">
        <div class="chartBox">
          <div class="chartTitle">Radi칩metro (promedio LDR)</div>
          <canvas id="cRad"></canvas>
          <div class="hint">Tip: pasa el dedo/rat칩n sobre la l칤nea para ver el valor.</div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const MAX_POINTS  = 80;     // ventana deslizante (sube/baja a tu gusto)
  const INTERVAL_MS = 3000;   // cada cu치nto actualiza

  // ========= UI Tabs =========
  function showTab(id, btn){
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(id).classList.add('active');

    document.querySelectorAll('.topbar .btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  }

  // ========= helpers =========
  function toNum(x){
    if (x === null || x === undefined) return null;
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function trimToMax(chart){
    const labels = chart.data.labels;
    const data = chart.data.datasets[0].data;

    while(labels.length > MAX_POINTS){
      labels.shift();
      data.shift();
    }
  }

  function pushPoint(chart, label, value){
    chart.data.labels.push(label);
    chart.data.datasets[0].data.push(value);
    trimToMax(chart);
  }

  // ========= Chart factory =========
  function makeChart(canvasId, label, suggestedMax){
    const ctx = document.getElementById(canvasId).getContext('2d');
    return new Chart(ctx, {
      type:'line',
      data:{
        labels:[],
        datasets:[{
          label,
          data:[],
          borderWidth: 2,
          tension: 0.32,
          pointRadius: 0,        // puntos invisibles (m치s fluido)
          pointHitRadius: 18,    // pero f치cil tocar con el dedo
          fill: false
        }]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false,
        animation:false,
        interaction:{
          mode:'index',
          intersect:false
        },
        plugins:{
          legend:{ display:true },
          tooltip:{
            enabled:true,
            mode:'index',
            intersect:false
          }
        },
        scales:{
          x:{
            ticks:{ maxTicksLimit: 10 },
            grid:{ display:false }
          },
          y:{
            beginAtZero:true,
            suggestedMax: suggestedMax,
            grid:{ color:'rgba(255,255,255,.06)' }
          }
        }
      }
    });
  }

  // ========= Charts =========
  window.chartTemp = makeChart("cTemp", "Temperatura (춿C)", 100);
  window.chartVolt = makeChart("cVolt", "Voltaje (V)", 25);
  window.chartCorr = makeChart("cCorr", "Corriente (A)", 5);
  window.chartPot  = makeChart("cPot",  "Potencia (W)", 200);
  window.chartRad  = makeChart("cRad",  "Radi칩metro", 4096);

  // ========= Data update =========
  async function actualizar(){
    try{
      const res = await fetch('/api/data', { cache:'no-store' });
      const arr = await res.json();

      if(!Array.isArray(arr)) return;

      document.getElementById("regCount").textContent = arr.length;

      // Tu backend regresa DESC (ORDER BY id DESC). Lo invertimos para dibujar cronol칩gico
      const datos = arr.slice().reverse();

      // Tomamos SOLO los 칰ltimos MAX_POINTS (para que NO se sature)
      const ultimos = datos.slice(Math.max(0, datos.length - MAX_POINTS));

      // Limpiamos antes de redibujar (m치s simple y estable)
      [chartTemp, chartVolt, chartCorr, chartPot, chartRad].forEach(ch => {
        ch.data.labels = [];
        ch.data.datasets[0].data = [];
      });

      // Llenamos
      ultimos.forEach(p => {
        const label = (p.hora || "").toString().slice(0,8); // HH:MM:SS

        const temp = toNum(p.temperatura);
        const volt = toNum(p.voltaje);
        const corr = toNum(p.corriente);
        const pot  = toNum(p.potencia);
        const rad  = toNum(p.radiometro);

        if(temp !== null) pushPoint(chartTemp, label, temp);
        if(volt !== null) pushPoint(chartVolt, label, volt);
        if(corr !== null) pushPoint(chartCorr, label, corr);
        if(pot  !== null) pushPoint(chartPot,  label, pot);
        if(rad  !== null) pushPoint(chartRad,  label, rad);
      });

      // Actualizamos sin animaci칩n
      chartTemp.update('none');
      chartVolt.update('none');
      chartCorr.update('none');
      chartPot.update('none');
      chartRad.update('none');

    }catch(e){
      console.log("Error update:", e);
    }
  }

  // ========= CSV download =========
  async function downloadCSV(){
    // Intento 1: si tienes endpoint /api/csv
    try{
      const r = await fetch('/api/csv', { cache:'no-store' });
      if(r.ok){
        const blob = await r.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'datos.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
        return;
      }
    }catch(e){}

    // Fallback: intenta /csv (por si ese fue tu endpoint anterior)
    window.location.href = '/csv';
  }

  // start
  actualizar();
  setInterval(actualizar, INTERVAL_MS);
</script>
</body>
</html>
