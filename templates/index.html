<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo ESP32 en la nube</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0e0f10;
      --card:#1a1c1f;
      --cyan:#11c5d9;
      --txt:#e9eef2;
      --muted:#aab6be;
      --btn:#22262a;
      --btnActive:#0fb9cc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 500px at 50% -100px, rgba(17,197,217,.25), transparent 60%), var(--bg);
      color:var(--txt);
      text-align:center;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 14px 40px}
    h1{
      margin:10px 0 6px;
      font-weight:800;
      letter-spacing:.5px;
      color:var(--cyan);
      text-shadow:0 0 24px rgba(17,197,217,.25);
    }
    .sub{color:var(--muted);margin:0 0 18px}
    .topbar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:14px 0 18px;
    }
    .btn{
      border:none;
      padding:10px 16px;
      border-radius:12px;
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      transition:transform .08s ease, background .15s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.active{background:var(--btnActive); color:#001014}
    .btn.csv{
      background:linear-gradient(135deg, rgba(17,197,217,.95), rgba(17,197,217,.75));
      color:#001014;
    }
    .cards{
      margin-top:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      padding:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.45);
    }
    .tab{display:none}
    .tab.active{display:block}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
    }
    .card{
      background: radial-gradient(900px 320px at 50% 0px, rgba(255,255,255,.06), transparent 65%), var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      padding:16px 14px 10px;
    }
    .card h2{
      margin:8px 0 8px;
      font-size:20px;
      font-weight:800;
    }
    canvas{width:100% !important; height:320px !important;}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Monitoreo ESP32 en la nube</h1>
    <p class="sub">Registros: <span id="count">0</span></p>

    <div class="topbar">
      <button class="btn active" data-tab="tTemp">Temperatura (춿C)</button>
      <button class="btn" data-tab="tPanel">Sensores de paneles</button>
      <button class="btn" data-tab="tRad">Radi칩metro</button>

      <button class="btn" data-tab="tW1">WROOM 1</button>
      <button class="btn" data-tab="tW2">WROOM 2</button>
      <button class="btn" data-tab="tW3">WROOM 3</button>

      <button class="btn csv" id="btnCSV">游닌 Descargar CSV</button>
    </div>

    <div class="cards">
      <!-- TAB TEMPERATURA (S2) -->
      <div id="tTemp" class="tab active">
        <div class="card">
          <h2>Temperatura (춿C)</h2>
          <canvas id="chTemp"></canvas>
          <div class="hint">Tip: pasa el dedo/rat칩n sobre la l칤nea para ver el valor.</div>
        </div>
      </div>

      <!-- TAB PANELES (S2) -->
      <div id="tPanel" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje (V)</h2>
            <canvas id="chVolt"></canvas>
          </div>
          <div class="card">
            <h2>Corriente (A)</h2>
            <canvas id="chCorr"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia (W)</h2>
          <canvas id="chPot"></canvas>
        </div>
      </div>

      <!-- TAB RADI칍METRO (S2) -->
      <div id="tRad" class="tab">
        <div class="card">
          <h2>Radi칩metro</h2>
          <canvas id="chRad"></canvas>
        </div>
      </div>

      <!-- TAB WROOM 1 -->
      <div id="tW1" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje 1 (V)</h2>
            <canvas id="chWv1"></canvas>
          </div>
          <div class="card">
            <h2>Corriente 1 (A)</h2>
            <canvas id="chWc1"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia 1 (W)</h2>
          <canvas id="chWp1"></canvas>
        </div>
      </div>

      <!-- TAB WROOM 2 -->
      <div id="tW2" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje 2 (V)</h2>
            <canvas id="chWv2"></canvas>
          </div>
          <div class="card">
            <h2>Corriente 2 (A)</h2>
            <canvas id="chWc2"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia 2 (W)</h2>
          <canvas id="chWp2"></canvas>
        </div>
      </div>

      <!-- TAB WROOM 3 -->
      <div id="tW3" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje 3 (V)</h2>
            <canvas id="chWv3"></canvas>
          </div>
          <div class="card">
            <h2>Corriente 3 (A)</h2>
            <canvas id="chWc3"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia 3 (W)</h2>
          <canvas id="chWp3"></canvas>
        </div>
      </div>

    </div>
  </div>

<script>
  // ========= CONFIG =========
  const API_BASE = "/api/data";
  const MAX_POINTS = 120;
  const REFRESH_MS = 3000;

  // ========= HELPERS =========
  function pad2(n){ return String(n).padStart(2,"0"); }

  function cleanTime(h){
    // "HH:MM:SS.ssssss" -> "HH:MM:SS"
    if(!h) return "00:00:00";
    return String(h).split(".")[0];
  }

  function parseDateTime(row){
    // row.fecha: "YYYY-MM-DD"
    // row.hora : "HH:MM:SS" (sin micros)
    const hh = cleanTime(row.hora);
    return new Date(`${row.fecha}T${hh}`);
  }

  function labelFromRow(row){
    return cleanTime(row.hora); // etiqueta corta
  }

  function clampNumber(x){
    if (x === null || x === undefined) return null;
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  // ========= CHART FACTORY =========
  function makeLineChart(canvasId, label, suggestedMax){
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label,
          data: [],
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
          fill: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 200 },
        parsing: false,
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true, mode: "nearest", intersect: false },
          decimation: { enabled: true, algorithm: "min-max" }
        },
        scales: {
          x: {
            ticks: { maxRotation: 0, autoSkip: true },
            grid: { display: false }
          },
          y: {
            beginAtZero: true,
            suggestedMax: suggestedMax,
            grid: { color: "rgba(255,255,255,.06)" }
          }
        }
      }
    });
  }

  // ========= CHARTS (S2) =========
  const chTemp = makeLineChart("chTemp", "Temperatura (춿C)", 120);
  const chVolt = makeLineChart("chVolt", "Voltaje (V)", 30);
  const chCorr = makeLineChart("chCorr", "Corriente (A)", 10);
  const chPot  = makeLineChart("chPot",  "Potencia (W)", 200);
  const chRad  = makeLineChart("chRad",  "Radi칩metro", 4096);

  // ========= CHARTS (WROOM) =========
  const chWv1 = makeLineChart("chWv1", "Voltaje 1 (V)", 30);
  const chWc1 = makeLineChart("chWc1", "Corriente 1 (A)", 10);
  const chWp1 = makeLineChart("chWp1", "Potencia 1 (W)", 200);

  const chWv2 = makeLineChart("chWv2", "Voltaje 2 (V)", 30);
  const chWc2 = makeLineChart("chWc2", "Corriente 2 (A)", 10);
  const chWp2 = makeLineChart("chWp2", "Potencia 2 (W)", 200);

  const chWv3 = makeLineChart("chWv3", "Voltaje 3 (V)", 30);
  const chWc3 = makeLineChart("chWc3", "Corriente 3 (A)", 10);
  const chWp3 = makeLineChart("chWp3", "Potencia 3 (W)", 200);

  const ALL_CHARTS = [chTemp, chVolt, chCorr, chPot, chRad, chWv1, chWc1, chWp1, chWv2, chWc2, chWp2, chWv3, chWc3, chWp3];

  // ========= TABS (FIX: resize when tab becomes visible) =========
  const tabBtns = document.querySelectorAll(".btn[data-tab]");
  const tabs = document.querySelectorAll(".tab");

  tabBtns.forEach(btn => {
    btn.addEventListener("click", async () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      tabs.forEach(t => t.classList.remove("active"));

      btn.classList.add("active");
      const tab = document.getElementById(btn.dataset.tab);
      tab.classList.add("active");

      // Espera m칤nimo para que el DOM calcule tama침o del canvas
      await new Promise(r => setTimeout(r, 80));

      // Fuerza recalcular tama침o y re-dibujar
      for (const c of ALL_CHARTS) {
        if (c) { c.resize(); c.update("none"); }
      }
    });
  });

  // ========= FETCH =========
  async function fetchDevice(device, limit=300){
    const res = await fetch(`${API_BASE}?device=${encodeURIComponent(device)}&limit=${limit}`, { cache:"no-store" });
    if(!res.ok) throw new Error(`API ${device} error ${res.status}`);
    const arr = await res.json();

    // La API suele venir DESC (nuevo->viejo). Dejamos ASC (viejo->nuevo) para graficar
    arr.sort((a,b) => parseDateTime(a) - parseDateTime(b));

    // ventana visible
    return arr.slice(-MAX_POINTS);
  }

  function setChart(chart, labels, data){
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  }

  async function refresh(){
    try{
      // S2
      const s2 = await fetchDevice("s2", 300);
      const labelsS2 = s2.map(labelFromRow);

      setChart(chTemp, labelsS2, s2.map(d => clampNumber(d.temperatura)));
      setChart(chVolt, labelsS2, s2.map(d => clampNumber(d.voltaje)));
      setChart(chCorr, labelsS2, s2.map(d => clampNumber(d.corriente)));
      setChart(chPot,  labelsS2, s2.map(d => clampNumber(d.potencia)));
      setChart(chRad,  labelsS2, s2.map(d => clampNumber(d.radiometro)));

      // WROOM
      const w = await fetchDevice("wroom", 300);
      const labelsW = w.map(labelFromRow);

      setChart(chWv1, labelsW, w.map(d => clampNumber(d.voltaje1)));
      setChart(chWc1, labelsW, w.map(d => clampNumber(d.corriente1)));
      setChart(chWp1, labelsW, w.map(d => clampNumber(d.potencia1)));

      setChart(chWv2, labelsW, w.map(d => clampNumber(d.voltaje2)));
      setChart(chWc2, labelsW, w.map(d => clampNumber(d.corriente2)));
      setChart(chWp2, labelsW, w.map(d => clampNumber(d.potencia2)));

      setChart(chWv3, labelsW, w.map(d => clampNumber(d.voltaje3)));
      setChart(chWc3, labelsW, w.map(d => clampNumber(d.corriente3)));
      setChart(chWp3, labelsW, w.map(d => clampNumber(d.potencia3)));

      // contador total: suma de ambos (aprox, ventana)
      document.getElementById("count").textContent = (s2.length + w.length);

      // Despu칠s de refrescar, por si est치s en pesta침a oculta
      for (const c of ALL_CHARTS) { if (c) c.update("none"); }

    } catch(e){
      console.log("refresh error:", e);
    }
  }

  // ========= CSV (1 bot칩n, TODO junto, sin device y sin microsegundos) =========
  function toCSV(rows){
    const header = [
      "id","fecha","hora",
      "voltaje","corriente","potencia","radiometro","temperatura",
      "voltaje1","voltaje2","voltaje3",
      "corriente1","corriente2","corriente3",
      "potencia1","potencia2","potencia3"
    ];
    const lines = [header.join(",")];

    for(const r of rows){
      lines.push([
        r.id ?? "",
        r.fecha ?? "",
        cleanTime(r.hora ?? ""),
        r.voltaje ?? "",
        r.corriente ?? "",
        r.potencia ?? "",
        r.radiometro ?? "",
        r.temperatura ?? "",
        r.voltaje1 ?? "",
        r.voltaje2 ?? "",
        r.voltaje3 ?? "",
        r.corriente1 ?? "",
        r.corriente2 ?? "",
        r.corriente3 ?? "",
        r.potencia1 ?? "",
        r.potencia2 ?? "",
        r.potencia3 ?? ""
      ].join(","));
    }
    return lines.join("\n");
  }

  document.getElementById("btnCSV").addEventListener("click", async () => {
    try{
      const [s2, w] = await Promise.all([
        fetch(`${API_BASE}?device=s2&limit=2000`, {cache:"no-store"}).then(r=>r.json()),
        fetch(`${API_BASE}?device=wroom&limit=2000`, {cache:"no-store"}).then(r=>r.json())
      ]);

      // junta todo y ordena por fecha+hora asc
      const all = [...s2, ...w];
      all.sort((a,b) => parseDateTime(a) - parseDateTime(b));

      const csv = toCSV(all);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;

      const now = new Date();
      a.download = `esp32_all_${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}_${pad2(now.getHours())}${pad2(now.getMinutes())}.csv`;

      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

    } catch(e){
      console.log("CSV error:", e);
      alert("Error descargando CSV. Revisa consola (F12).");
    }
  });

  // ========= START =========
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
