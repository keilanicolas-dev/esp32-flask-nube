<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitoreo ESP32 en la nube</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            background-color: #121212;
            color: #E0E0E0;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            text-align: center;
        }
        header {
            background: #1F1F1F;
            padding: 15px;
            margin-bottom: 10px;
        }
        h1 {
            margin: 0;
            color: #00BCD4;
        }
        #contador {
            color: #B0BEC5;
            font-size: 14px;
        }
        .tabs {
            margin-top: 8px;
        }
        .tabs button {
            background:#263238;
            border:none;
            color:#E0E0E0;
            padding:8px 14px;
            margin:0 4px;
            border-radius:6px;
            cursor:pointer;
            font-weight:bold;
        }
        .tabs button.active {
            background:#00BCD4;
            color:#000;
        }
        .view {
            display:none;
        }
        .view.active {
            display:block;
        }
        .grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            padding: 10px;
        }
        .card {
            background: #1E1E1E;
            border-radius: 10px;
            padding: 15px;
            width: 420px;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        canvas {
            width: 100% !important;
            height: 250px !important;
        }
        a.btn {
            display:inline-block;
            margin-top:10px;
            padding:8px 14px;
            background:#00BCD4;
            color:#000;
            border-radius:6px;
            text-decoration:none;
            font-weight:bold;
        }
    </style>
</head>
<body>
<header>
    <h1>ðŸ“¡ Monitoreo ESP32 en la nube</h1>
    <p id="contador">Registros: 0</p>
    <div class="tabs">
        <button class="tab-btn active" data-target="tab-temp">Temperatura (Â°C)</button>
        <button class="tab-btn" data-target="tab-grupo1">Sensores 1</button>
        <button class="tab-btn" data-target="tab-rad">RadiÃ³metro</button>
    </div>
    <a class="btn" href="/api/csv">ðŸ“¥ Descargar CSV</a>
</header>

<!-- TAB 1: Voltaje 2 -->
<div id="tab-temp" class="view active">
    <div class="grid">
        <div class="card">
            <h3>Temperatura (Â°C)</h3>
<canvas id="grafVoltaje2"></canvas>
        </div>
    </div>
</div>

<!-- TAB 2: grupo principal -->
<div id="tab-grupo1" class="view">
    <div class="grid">
        <div class="card">
            <h3>Voltaje 1 (V)</h3>
            <canvas id="grafVoltaje1"></canvas>
        </div>
        <div class="card">
            <h3>Corriente 1 (A)</h3>
            <canvas id="grafCorriente1"></canvas>
        </div>
        <div class="card">
            <h3>Potencia 1 (W)</h3>
            <canvas id="grafPotencia1"></canvas>
        </div>
    </div>
</div>

<!-- TAB 3: radiÃ³metro -->
<div id="tab-rad" class="view">
    <div class="grid">
        <div class="card">
            <h3>RadiÃ³metro</h3>
            <canvas id="grafRad"></canvas>
        </div>
    </div>
</div>

<script>
    // Tabs
    const tabBtns = document.querySelectorAll(".tab-btn");
    const views = document.querySelectorAll(".view");
    tabBtns.forEach(btn => {
        btn.addEventListener("click", () => {
            tabBtns.forEach(b => b.classList.remove("active"));
            views.forEach(v => v.classList.remove("active"));
            btn.classList.add("active");
            document.getElementById(btn.dataset.target).classList.add("active");
        });
    });

    // Crear grÃ¡ficos
    const makeChart = (id, label, maxY) => {
    const ctx = document.getElementById(id).getContext("2d");
    return new Chart(ctx, {
        type: "line",
        data: {
            labels: [],
            datasets: [{
                label,
                data: [],
                borderColor: "#00BCD4",
                tension: 0.35,      // curva un poco mÃ¡s suave
                fill: false,
                pointRadius: 0,     // ðŸ‘ˆ sin bolitas
                pointHoverRadius: 0
            }]
        },
        options: {
            animation: {
                duration: 400,     // ðŸ‘ˆ animaciÃ³n suave
                easing: "linear"
            },
            plugins: {
                legend: { display: true }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: {
                        maxTicksLimit: 6,   // ðŸ‘ˆ como mucho 6 etiquetas
                        autoSkip: true,
                        callback: function (val) {
                            // label = "HH:MM:SS" â†’ mostramos solo "HH:MM"
                            const label = this.getLabelForValue(val) || "";
                            return label.substring(0, 5);
                        }
                    }
                },
                y: {
                    grid: { display: false },
                    suggestedMin: 0,
                    suggestedMax: maxY
                }
            }
        }
    });
};


    const chartV1 = makeChart("grafVoltaje1", "Voltaje 1 (V)", 20);
   const chartV2 = makeChart("grafVoltaje2", "Temperatura (Â°C)", 80); // o el rango que quieras
    const chartC1 = makeChart("grafCorriente1", "Corriente 1 (A)", 5);
    const chartP1 = makeChart("grafPotencia1", "Potencia 1 (W)", 200);
    const chartRad = makeChart("grafRad", "Radiometro", 4095);

    async function actualizar() {
        try {
            const res = await fetch("/api/data?n=40");
            const datos = await res.json();

            document.getElementById("contador").innerText = "Registros: " + datos.length;

            const labels = datos.map(d => (d.fecha || "").split(" ")[1] || "");

            chartV1.data.labels = labels;
            chartV2.data.labels = labels;
            chartC1.data.labels = labels;
            chartP1.data.labels = labels;
            chartRad.data.labels = labels;

            chartV1.data.datasets[0].data = datos.map(d => d.voltaje1 || 0);
            chartV2.data.datasets[0].data = datos.map(d => d.voltaje2 || 0);
            chartC1.data.datasets[0].data = datos.map(d => d.corriente1 || 0);
            chartP1.data.datasets[0].data = datos.map(d => d.potencia1 || 0);
            chartRad.data.datasets[0].data = datos.map(d => d.radiometro || 0);

            chartV1.update();
            chartV2.update();
            chartC1.update();
            chartP1.update();
            chartRad.update();
        } catch (e) {
            console.error("Error al actualizar datos:", e);
        }
    }

    actualizar();
    setInterval(actualizar, 5000);
</script>
</body>
</html>
