<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monitoreo ESP32 en la nube</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0b0d0f;
      --card:#16181b;
      --cyan:#10c7d9;
      --txt:#e9eef2;
      --muted:#aab6be;
      --btn:#23272b;
      --btnActive:#10c7d9;
    }
    body{
      margin:0;
      font-family:system-ui,Segoe UI,Roboto,Arial;
      background:radial-gradient(1200px 500px at 50% -100px, rgba(16,199,217,.25), transparent 60%), var(--bg);
      color:var(--txt);
      text-align:center;
    }
    h1{color:var(--cyan);margin:16px 0 4px}
    .wrap{max-width:1200px;margin:auto;padding:12px}
    .topbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:14px 0}
    button{
      background:var(--btn);
      color:var(--txt);
      border:none;
      border-radius:12px;
      padding:10px 16px;
      cursor:pointer;
      font-weight:700;
    }
    button.active{background:var(--btnActive);color:#001014}
    button.csv{background:linear-gradient(135deg,#10c7d9,#0fb0c0);color:#001014}
    .card{
      background:var(--card);
      border-radius:18px;
      padding:16px;
      margin-top:12px;
      box-shadow:0 12px 30px rgba(0,0,0,.5);
    }
    canvas{width:100%!important;height:360px!important}
    .tab{display:none}
    .tab.active{display:block}
  </style>
</head>

<body>
<div class="wrap">
  <h1>Monitoreo ESP32 en la nube</h1>
  <p>Registros: <b id="count">0</b></p>

  <div class="topbar">
    <button class="active" data-tab="temp">Temperatura (춿C)</button>
    <button data-tab="sens">Sensores</button>
    <button data-tab="rad">Radi칩metro</button>
    <button class="csv" id="btnCSV">游닌 Descargar CSV</button>
  </div>

  <div id="temp" class="tab active">
    <div class="card">
      <h2>Temperatura (춿C)</h2>
      <canvas id="chTemp"></canvas>
    </div>
  </div>

  <div id="sens" class="tab">
    <div class="card">
      <h2>Voltaje (V)</h2>
      <canvas id="chVolt"></canvas>
    </div>
    <div class="card">
      <h2>Corriente (A)</h2>
      <canvas id="chCorr"></canvas>
    </div>
    <div class="card">
      <h2>Potencia (W)</h2>
      <canvas id="chPot"></canvas>
    </div>
  </div>

  <div id="rad" class="tab">
    <div class="card">
      <h2>Radi칩metro</h2>
      <canvas id="chRad"></canvas>
    </div>
  </div>
</div>

<script>
/* ================= CONFIG ================= */
const API = "/api/data";
const MAX_POINTS = 120;
const REFRESH_MS = 3000;

/* M칄XICO UTC-6 (sin tocar Thonny) */
const TZ_OFFSET_MIN = -6 * 60;

/* ================= TABS ================= */
document.querySelectorAll("button[data-tab]").forEach(b=>{
  b.onclick=()=>{
    document.querySelectorAll("button").forEach(x=>x.classList.remove("active"));
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    b.classList.add("active");
    document.getElementById(b.dataset.tab).classList.add("active");
  }
});

/* ================= CHART FACTORY ================= */
function makeChart(id,label,max){
  return new Chart(document.getElementById(id),{
    type:"line",
    data:{labels:[],datasets:[{
      label,
      data:[],
      borderWidth:2,
      tension:.25,
      pointRadius:0
    }]},
    options:{
      responsive:true,
      animation:{duration:300},
      interaction:{mode:"nearest",intersect:false},
      scales:{
        y:{beginAtZero:true,suggestedMax:max},
        x:{grid:{display:false}}
      }
    }
  });
}

const chTemp = makeChart("chTemp","Temperatura 춿C",120);
const chVolt = makeChart("chVolt","Voltaje V",30);
const chCorr = makeChart("chCorr","Corriente A",10);
const chPot  = makeChart("chPot","Potencia W",200);
const chRad  = makeChart("chRad","Radi칩metro",4096);

/* ================= TIME UTILS ================= */
function toLocalLabel(r){
  const hhmmss=(r.hora||"00:00:00").split(".")[0];
  const utc=new Date(`${r.fecha}T${hhmmss}Z`);
  const local=new Date(utc.getTime()+TZ_OFFSET_MIN*60000);
  return local.toLocaleTimeString("es-MX",{hour12:false});
}

/* ================= FETCH ================= */
async function refresh(){
  try{
    const res=await fetch(API,{cache:"no-store"});
    const data=await res.json();

    data.sort((a,b)=>{
      return new Date(`${a.fecha}T${(a.hora||"00:00:00").split(".")[0]}Z`) -
             new Date(`${b.fecha}T${(b.hora||"00:00:00").split(".")[0]}Z`);
    });

    document.getElementById("count").textContent=data.length;

    const view=data.slice(-MAX_POINTS);
    const labels=view.map(toLocalLabel);

    function upd(chart,arr){
      chart.data.labels=labels;
      chart.data.datasets[0].data=arr;
      chart.update();
    }

    upd(chTemp,view.map(d=>d.temperatura));
    upd(chVolt,view.map(d=>d.voltaje));
    upd(chCorr,view.map(d=>d.corriente));
    upd(chPot ,view.map(d=>d.potencia));
    upd(chRad ,view.map(d=>d.radiometro));

  }catch(e){
    console.log("Error:",e);
  }
}

/* ================= CSV ================= */
document.getElementById("btnCSV").onclick=async()=>{
  const r=await fetch(API);
  const d=await r.json();
  let csv="fecha,hora,voltaje,corriente,potencia,radiometro,temperatura\n";
  d.forEach(x=>{
    csv+=`${x.fecha},${(x.hora||"").split(".")[0]},${x.voltaje},${x.corriente},${x.potencia},${x.radiometro},${x.temperatura}\n`;
  });
  const blob=new Blob([csv],{type:"text/csv"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="esp32.csv";
  a.click();
};

/* ================= START ================= */
refresh();
setInterval(refresh,REFRESH_MS);
</script>
</body>
</html>

