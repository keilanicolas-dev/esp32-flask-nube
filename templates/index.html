<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo ESP32 en la nube</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#ffffff;
      --card:#e1e5ea;
      --cyan:#0b6cff;
      --txt:#1a1a1a;
      --muted:#5f6b76;
      --btn:#e6e9ed;
      --btnActive:#0b6cff;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: var(--bg);
      color:var(--txt);
      text-align:center;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 14px 40px}
    h1{
      margin:10px 0 6px;
      font-weight:800;
      letter-spacing:.5px;
      color:var(--cyan);
    }
    .topbar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:14px 0 18px;
    }
    .btn{
      border:none;
      padding:10px 16px;
      border-radius:12px;
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      transition:transform .08s ease, background .15s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.active{background:var(--btnActive); color:#fff}
    .btn.csv{
      background:linear-gradient(135deg, rgba(11,108,255,.95), rgba(11,108,255,.70));
      color:#fff;
    }
    .cards{
      margin-top:10px;
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      padding:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.12);
      background:#fff;
    }
    .tab{display:none}
    .tab.active{display:block}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
    }
    .card{
      background: var(--card);
      border:1px solid rgba(0,0,0,.08);
      border-radius:22px;
      padding:16px 14px 10px;
    }
    .card h2{
      margin:8px 0 8px;
      font-size:20px;
      font-weight:800;
    }
    canvas{width:100% !important; height:320px !important;}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Monitoreo ESP32 en la nube</h1>

    <div class="topbar">
      <button class="btn active" data-tab="tTemp">Temperatura (°C)</button>
      <button class="btn" data-tab="tSens">Sensores de paneles</button>
      <button class="btn" data-tab="tRad">Radiómetro</button>
      <button class="btn" data-tab="tW1">Sensores 1</button>
      <button class="btn" data-tab="tW2">Sensores 2</button>
      <button class="btn" data-tab="tW3">Sensores 3</button>

      <button class="btn" id="btnClear">Limpiar gráficas</button>
      <button class="btn csv" id="btnCSV">Descargar CSV</button>
    </div>

    <div class="cards">

      <!-- TEMPERATURA -->
      <div id="tTemp" class="tab active">
        <div class="card">
          <h2>Temperatura (°C)</h2>
          <canvas id="chTemp"></canvas>
          <div class="hint">Tip: pasa el dedo/ratón sobre la línea para ver el valor.</div>
        </div>
      </div>

      <!-- S2: SENSORES DE PANELES -->
      <div id="tSens" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje (V)</h2>
            <canvas id="chVolt"></canvas>
          </div>
          <div class="card">
            <h2>Corriente (A)</h2>
            <canvas id="chCorr"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia (W)</h2>
          <canvas id="chPot"></canvas>
        </div>
      </div>

      <!-- S2: RADIÓMETRO -->
      <div id="tRad" class="tab">
        <div class="card">
          <h2>Radiómetro</h2>
          <canvas id="chRad"></canvas>
        </div>
      </div>

      <!-- WROOM 1 -->
      <div id="tW1" class="tab">
        <div class="grid2">
          <div class="card"><h2>WROOM Voltaje 1</h2><canvas id="chWv1"></canvas></div>
          <div class="card"><h2>WROOM Corriente 1</h2><canvas id="chWc1"></canvas></div>
        </div>
        <div style="height:14px"></div>
        <div class="card"><h2>WROOM Potencia 1</h2><canvas id="chWp1"></canvas></div>
      </div>

      <!-- WROOM 2 -->
      <div id="tW2" class="tab">
        <div class="grid2">
          <div class="card"><h2>WROOM Voltaje 2</h2><canvas id="chWv2"></canvas></div>
          <div class="card"><h2>WROOM Corriente 2</h2><canvas id="chWc2"></canvas></div>
        </div>
        <div style="height:14px"></div>
        <div class="card"><h2>WROOM Potencia 2</h2><canvas id="chWp2"></canvas></div>
      </div>

      <!-- WROOM 3 -->
      <div id="tW3" class="tab">
        <div class="grid2">
          <div class="card"><h2>WROOM Voltaje 3</h2><canvas id="chWv3"></canvas></div>
          <div class="card"><h2>WROOM Corriente 3</h2><canvas id="chWc3"></canvas></div>
        </div>
        <div style="height:14px"></div>
        <div class="card"><h2>WROOM Potencia 3</h2><canvas id="chWp3"></canvas></div>
      </div>

    </div>
  </div>

<script>
  // ================= CONFIG =================
  const MAX_POINTS = 120;
  const REFRESH_MS = 3000;

  // cortes: después de limpiar solo entran nuevos
  let sinceIdS2 = null;
  let sinceIdW  = null;

  // buffers vivos
  let bufS2 = [];
  let bufW  = [];

  // ================= HELPERS =================
  function pad2(n){ return String(n).padStart(2,"0"); }

  function hourLabel(row){
    const h = (row.hora || "").split(".")[0];
    return h || "--:--:--";
  }

  function parseRowTime(row){
    const h = (row.hora || "00:00:00").split(".")[0];
    return new Date(`${row.fecha}T${h}`);
  }

  function pickNumber(obj, keys){
    for (const k of keys){
      const v = obj?.[k];
      if (v === null || v === undefined) continue;
      const n = Number(v);
      if (Number.isFinite(n)) return n;
    }
    return null;
  }

  async function fetchDevice(device, limit=300, since_id=null){
    const qs = new URLSearchParams({ device, limit: String(limit) });
    if (since_id !== null) qs.set("since_id", String(since_id));

    const res = await fetch(`/api/data?${qs.toString()}`, {cache:"no-store"});
    if(!res.ok) throw new Error("API error "+res.status);
    const arr = await res.json();

    // orden cronológico (viejo->nuevo)
    arr.sort((a,b) => parseRowTime(a) - parseRowTime(b));
    return arr;
  }

  // ================= CHART FACTORY =================
  function makeLineChart(canvasId, label, yMax){
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          label,
          data: [],
          borderWidth: 2,
          pointRadius: 0,
          tension: 0.25,
          fill: false,
          spanGaps: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 200 },
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          legend: { display: true },
          tooltip: { enabled: true, mode: "nearest", intersect: false },
          decimation: { enabled: true, algorithm: "min-max" }
        },
        scales: {
          x: {
            ticks: { maxRotation: 0, autoSkip: true },
            grid: { display: false }
          },
          y: {
            min: 0,
            max: yMax,              // ✅ escala fija
            grid: { color: "rgba(0,0,0,.10)" }
          }
        }
      }
    });
  }

  // ================= CHARTS (RANGOS) =================
  // temperatura (deja 0-120)
  const chTemp = makeLineChart("chTemp", "Temperatura (°C)", 120);

  // ✅ VOLTAJES 0-20
  const chVolt = makeLineChart("chVolt", "Voltaje (V)", 20);
  const chWv1  = makeLineChart("chWv1",  "Voltaje 1 (V)", 20);
  const chWv2  = makeLineChart("chWv2",  "Voltaje 2 (V)", 20);
  const chWv3  = makeLineChart("chWv3",  "Voltaje 3 (V)", 20);

  // ✅ CORRIENTES 0-1
  const chCorr = makeLineChart("chCorr", "Corriente (A)", 1);
  const chWc1  = makeLineChart("chWc1",  "Corriente 1 (A)", 1);
  const chWc2  = makeLineChart("chWc2",  "Corriente 2 (A)", 1);
  const chWc3  = makeLineChart("chWc3",  "Corriente 3 (A)", 1);

  // ✅ POTENCIAS 0-10
  const chPot  = makeLineChart("chPot",  "Potencia (W)", 10);
  const chWp1  = makeLineChart("chWp1",  "Potencia 1 (W)", 10);
  const chWp2  = makeLineChart("chWp2",  "Potencia 2 (W)", 10);
  const chWp3  = makeLineChart("chWp3",  "Potencia 3 (W)", 10);

  // ✅ RAD 0-105
  const chRad  = makeLineChart("chRad",  "Radiómetro", 105);

  const chartsByTab = {
    tTemp: [chTemp],
    tSens: [chVolt, chCorr, chPot],
    tRad:  [chRad],
    tW1:   [chWv1, chWc1, chWp1],
    tW2:   [chWv2, chWc2, chWp2],
    tW3:   [chWv3, chWc3, chWp3],
  };

  function setChart(chart, labels, data){
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update("none");
  }

  // ================= TABS (FIX RESIZE) =================
  const tabBtns = document.querySelectorAll(".btn[data-tab]");
  const tabs = document.querySelectorAll(".tab");

  function resizeTab(tabId){
    const list = chartsByTab[tabId] || [];
    for(const ch of list){
      ch.resize();
      ch.update("none");
    }
  }

  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      tabs.forEach(t => t.classList.remove("active"));

      btn.classList.add("active");
      const tabId = btn.dataset.tab;
      document.getElementById(tabId).classList.add("active");

      setTimeout(() => resizeTab(tabId), 0);
    });
  });

  window.addEventListener("resize", () => {
    const active = document.querySelector(".tab.active")?.id;
    if(active) resizeTab(active);
  });

  // ================= LIMPIAR =================
  function clearChart(chart){
    chart.data.labels = [];
    chart.data.datasets.forEach(ds => ds.data = []);
    chart.update();
  }

  document.getElementById("btnClear").addEventListener("click", async () => {
    try{
      const [s2Latest, wLatest] = await Promise.all([
        fetchDevice("s2", 1, null),
        fetchDevice("wroom", 1, null),
      ]);

      const lastS2 = s2Latest.length ? s2Latest[s2Latest.length - 1] : null;
      const lastW  = wLatest.length  ? wLatest[wLatest.length  - 1] : null;

      sinceIdS2 = lastS2 ? lastS2.id : sinceIdS2;
      sinceIdW  = lastW  ? lastW.id  : sinceIdW;

      bufS2 = [];
      bufW  = [];

      [
        chTemp,chVolt,chCorr,chPot,chRad,
        chWv1,chWc1,chWp1,
        chWv2,chWc2,chWp2,
        chWv3,chWc3,chWp3
      ].forEach(clearChart);

      console.log("Limpiadas. Entrarán solo datos nuevos. sinceIdS2=", sinceIdS2, "sinceIdW=", sinceIdW);
    }catch(e){
      console.log("Error al limpiar:", e);
    }
  });

  // ================= REFRESH =================
  async function refresh(){
    try{
      if (sinceIdS2 === null || sinceIdW === null){
        const [s2All, wAll] = await Promise.all([
          fetchDevice("s2", 600, null),
          fetchDevice("wroom", 600, null),
        ]);

        bufS2 = s2All.slice(-MAX_POINTS);
        bufW  = wAll.slice(-MAX_POINTS);

        sinceIdS2 = bufS2.length ? bufS2[bufS2.length - 1].id : sinceIdS2;
        sinceIdW  = bufW.length  ? bufW[bufW.length  - 1].id : sinceIdW;

      } else {
        const [s2New, wNew] = await Promise.all([
          fetchDevice("s2", 300, sinceIdS2),
          fetchDevice("wroom", 300, sinceIdW),
        ]);

        if (s2New.length){
          sinceIdS2 = s2New[s2New.length - 1].id;
          bufS2 = bufS2.concat(s2New).slice(-MAX_POINTS);
        }
        if (wNew.length){
          sinceIdW = wNew[wNew.length - 1].id;
          bufW = bufW.concat(wNew).slice(-MAX_POINTS);
        }
      }

      // S2
      const labelsS2 = bufS2.map(hourLabel);
      setChart(chTemp, labelsS2, bufS2.map(d => pickNumber(d, ["temperatura"])));
      setChart(chVolt, labelsS2, bufS2.map(d => pickNumber(d, ["voltaje"])));
      setChart(chCorr, labelsS2, bufS2.map(d => pickNumber(d, ["corriente"])));
      setChart(chPot,  labelsS2, bufS2.map(d => pickNumber(d, ["potencia"])));
      setChart(chRad,  labelsS2, bufS2.map(d => pickNumber(d, ["radiometro"])));

      // WROOM
      const labelsW = bufW.map(hourLabel);
      setChart(chWv1, labelsW, bufW.map(d => pickNumber(d, ["voltaje1"])));
      setChart(chWc1, labelsW, bufW.map(d => pickNumber(d, ["corriente1"])));
      setChart(chWp1, labelsW, bufW.map(d => pickNumber(d, ["potencia1"])));

      setChart(chWv2, labelsW, bufW.map(d => pickNumber(d, ["voltaje2"])));
      setChart(chWc2, labelsW, bufW.map(d => pickNumber(d, ["corriente2"])));
      setChart(chWp2, labelsW, bufW.map(d => pickNumber(d, ["potencia2"])));

      setChart(chWv3, labelsW, bufW.map(d => pickNumber(d, ["voltaje3"])));
      setChart(chWc3, labelsW, bufW.map(d => pickNumber(d, ["corriente3"])));
      setChart(chWp3, labelsW, bufW.map(d => pickNumber(d, ["potencia3"])));

      const active = document.querySelector(".tab.active")?.id;
      if(active) resizeTab(active);

    }catch(e){
      console.log("refresh error:", e);
    }
  }

  // ================= CSV (UN SOLO BOTÓN) =================
  function toCSV(rows){
    const header = [
      "id","fecha","hora",
      "voltaje","corriente","potencia","radiometro","temperatura",
      "voltaje1","voltaje2","voltaje3",
      "corriente1","corriente2","corriente3",
      "potencia1","potencia2","potencia3"
    ];
    const lines = [header.join(",")];

    for(const r of rows){
      lines.push([
        r.id ?? "",
        r.fecha ?? "",
        (r.hora ?? "").split(".")[0],
        r.voltaje ?? "",
        r.corriente ?? "",
        r.potencia ?? "",
        r.radiometro ?? "",
        r.temperatura ?? "",
        r.voltaje1 ?? "",
        r.voltaje2 ?? "",
        r.voltaje3 ?? "",
        r.corriente1 ?? "",
        r.corriente2 ?? "",
        r.corriente3 ?? "",
        r.potencia1 ?? "",
        r.potencia2 ?? "",
        r.potencia3 ?? ""
      ].join(","));
    }
    return lines.join("\n");
  }

  document.getElementById("btnCSV").addEventListener("click", async () => {
    const [s2, w] = await Promise.all([
      fetchDevice("s2", 5000, null),
      fetchDevice("wroom", 5000, null)
    ]);
    const all = [...s2, ...w];
    all.sort((a,b) => parseRowTime(a) - parseRowTime(b));

    const csv = toCSV(all);
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    const now = new Date();
    a.download = `esp32_${now.getFullYear()}-${pad2(now.getMonth()+1)}-${pad2(now.getDate())}_${pad2(now.getHours())}${pad2(now.getMinutes())}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // ================= START =================
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
