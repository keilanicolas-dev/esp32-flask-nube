<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo ESP32 en la nube</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --bg:#0e0f10;
      --card:#1a1c1f;
      --cyan:#11c5d9;
      --txt:#e9eef2;
      --muted:#aab6be;
      --btn:#22262a;
      --btnActive:#0fb9cc;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 500px at 50% -100px, rgba(17,197,217,.25), transparent 60%), var(--bg);
      color:var(--txt);
      text-align:center;
    }
    .wrap{max-width:1200px;margin:0 auto;padding:24px 14px 40px}
    h1{
      margin:10px 0 6px;
      font-weight:800;
      letter-spacing:.5px;
      color:var(--cyan);
      text-shadow:0 0 24px rgba(17,197,217,.25);
    }
    .sub{color:var(--muted);margin:0 0 18px}
    .topbar{
      display:flex;
      flex-wrap:wrap;
      justify-content:center;
      gap:10px;
      margin:14px 0 18px;
    }
    .btn{
      border:none;
      padding:10px 16px;
      border-radius:12px;
      background:var(--btn);
      color:var(--txt);
      cursor:pointer;
      font-weight:700;
      transition:transform .08s ease, background .15s ease;
    }
    .btn:active{transform:scale(.98)}
    .btn.active{background:var(--btnActive); color:#001014}
    .btn.csv{
      background:linear-gradient(135deg, rgba(17,197,217,.95), rgba(17,197,217,.75));
      color:#001014;
    }
    .cards{
      margin-top:10px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      padding:18px;
      box-shadow:0 14px 40px rgba(0,0,0,.45);
    }
    .tab{display:none}
    .tab.active{display:block}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width:900px){
      .grid2{grid-template-columns:1fr}
    }
    .card{
      background: radial-gradient(900px 320px at 50% 0px, rgba(255,255,255,.06), transparent 65%), var(--card);
      border:1px solid rgba(255,255,255,.06);
      border-radius:22px;
      padding:16px 14px 10px;
    }
    .card h2{
      margin:8px 0 8px;
      font-size:20px;
      font-weight:800;
    }
    canvas{width:100% !important; height:320px !important;}
    .hint{
      margin-top:10px;
      color:var(--muted);
      font-size:13px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <h1>Monitoreo ESP32 en la nube</h1>
    <p class="sub">Registros: <span id="count">0</span></p>

    <div class="topbar">
      <button class="btn active" data-tab="tTemp">Temperatura (Â°C)</button>
      <button class="btn" data-tab="tPaneles">Sensores de paneles</button>
      <button class="btn" data-tab="tRad">RadiÃ³metro</button>

      <button class="btn" data-tab="tW1">WROOM 1</button>
      <button class="btn" data-tab="tW2">WROOM 2</button>
      <button class="btn" data-tab="tW3">WROOM 3</button>

      <button class="btn csv" id="btnCSV">ðŸ“¥ Descargar CSV</button>
    </div>

    <div class="cards">
      <!-- TAB TEMPERATURA (S2) -->
      <div id="tTemp" class="tab active">
        <div class="card">
          <h2>Temperatura (Â°C)</h2>
          <canvas id="chTemp"></canvas>
          <div class="hint">Tip: pasa el dedo/ratÃ³n sobre la lÃ­nea para ver el valor.</div>
        </div>
      </div>

      <!-- TAB PANELES (S2) -->
      <div id="tPaneles" class="tab">
        <div class="grid2">
          <div class="card">
            <h2>Voltaje (V)</h2>
            <canvas id="chVolt"></canvas>
          </div>
          <div class="card">
            <h2>Corriente (A)</h2>
            <canvas id="chCorr"></canvas>
          </div>
        </div>
        <div style="height:14px"></div>
        <div class="card">
          <h2>Potencia (W)</h2>
          <canvas id="chPot"></canvas>
        </div>
      </div>

      <!-- TAB RADIÃ“METRO (S2) -->
      <div id="tRad" class="tab">
        <div class="card">
          <h2>RadiÃ³metro</h2>
          <canvas id="chRad"></canvas>
        </div>
      </div>

      <!-- WROOM 1 -->
      <div id="tW1" class="tab">
        <div class="grid2">
          <div class="card"><h2>Voltaje 1 (V)</h2><canvas id="chV1"></canvas></div>
          <div class="card"><h2>Corriente 1 (A)</h2><canvas id="chC1"></canvas></div>
        </div>
        <div style="height:14px"></div>
        <div class="card"><h2>Potencia 1 (W)</h2><canvas id="chP1"></canvas></div>
      </div>

      <!-- WROOM 2 -->
      <div id="tW2" class="tab">
        <div class="grid2">
          <div class="card"><h2>Voltaje 2 (V)</h2><canvas id="chV2"></canvas></div>
          <div class="card"><h2>Corriente 2 (A)</h2><canvas id="chC2"></canvas></div>
        </div>
        <div style="height:14px"></div>
        <div class="card"><h2>Potencia 2 (W)</h2><canvas id="chP2"></canvas></div>
      </div>

      <!-- WROOM 3 -->
      <div id="tW3" class="tab">
        <div class="grid2">
          <div class="card"><h2>Voltaje 3 (V)</h2><canvas id="chV3"></canvas></div>
          <div class="card"><h2>Corriente 3 (A)</h2><canvas id="chC3"></canvas></div>
        </div>
        <div style="height:14px"></div>
        <div class="card"><h2>Potencia 3 (W)</h2><canvas id="chP3"></canvas></div>
      </div>
    </div>
  </div>

<script>
  // ========= CONFIG =========
  const API_S2    = "/api/data?device=s2&limit=300";
  const API_WROOM = "/api/data?device=wroom&limit=300";
  const CSV_URL   = "/api/csv";
  const MAX_POINTS = 120;        // ventana visible (evita saturaciÃ³n)
  const REFRESH_MS = 3000;

  // ========= TABS =========
  const tabBtns = document.querySelectorAll(".btn[data-tab]");
  const tabs = document.querySelectorAll(".tab");
  tabBtns.forEach(btn => {
    btn.addEventListener("click", () => {
      tabBtns.forEach(b => b.classList.remove("active"));
      tabs.forEach(t => t.classList.remove("active"));
      btn.classList.add("active");
      document.getElementById(btn.dataset.tab).classList.add("active");
    });
  });

  // ========= CHART FACTORY =========
  function makeLineChart(canvasId, label, suggestedMax){
    const ctx = document.getElementById(canvasId).getContext("2d");
    return new Chart(ctx, {
      type: "line",
      data: { labels: [], datasets: [{
        label, data: [],
        borderWidth: 2,
        pointRadius: 0,
        tension: 0.25,
        fill: false
      }]},
      options: {
        responsive: true,
        animation: { duration: 250 },
        parsing: false,
        interaction: { mode: "nearest", intersect: false },
        plugins: {
          tooltip: { enabled: true, mode: "nearest", intersect: false },
          decimation: { enabled: true, algorithm: "min-max" }
        },
        scales: {
          x: { ticks: { maxRotation: 0, autoSkip: true }, grid: { display: false } },
          y: { beginAtZero: true, suggestedMax, grid: { color: "rgba(255,255,255,.06)" } }
        }
      }
    });
  }

  // S2
  const chTemp = makeLineChart("chTemp", "Temperatura (Â°C)", 120);
  const chVolt = makeLineChart("chVolt", "Voltaje (V)", 30);
  const chCorr = makeLineChart("chCorr", "Corriente (A)", 10);
  const chPot  = makeLineChart("chPot",  "Potencia (W)", 200);
  const chRad  = makeLineChart("chRad",  "RadiÃ³metro", 4096);

  // WROOM
  const chV1 = makeLineChart("chV1", "Voltaje 1 (V)", 30);
  const chC1 = makeLineChart("chC1", "Corriente 1 (A)", 10);
  const chP1 = makeLineChart("chP1", "Potencia 1 (W)", 200);

  const chV2 = makeLineChart("chV2", "Voltaje 2 (V)", 30);
  const chC2 = makeLineChart("chC2", "Corriente 2 (A)", 10);
  const chP2 = makeLineChart("chP2", "Potencia 2 (W)", 200);

  const chV3 = makeLineChart("chV3", "Voltaje 3 (V)", 30);
  const chC3 = makeLineChart("chC3", "Corriente 3 (A)", 10);
  const chP3 = makeLineChart("chP3", "Potencia 3 (W)", 200);

  // ========= HELPERS =========
  function clampNumber(x){
    if (x === null || x === undefined) return null;
    const n = Number(x);
    return Number.isFinite(n) ? n : null;
  }

  function cleanHora(h){
    if(!h) return "00:00:00";
    return String(h).split(".")[0]; // âœ… por si viniera con microsegundos
  }

  function sortChronoAsc(arr){
    // tu API devuelve DESC (nuevo->viejo). La ordenamos ASC para graficar bien.
    arr.sort((a,b) => {
      const ta = `${a.fecha||""} ${cleanHora(a.hora)}`;
      const tb = `${b.fecha||""} ${cleanHora(b.hora)}`;
      return ta.localeCompare(tb);
    });
  }

  function labelsFrom(arr){
    return arr.map(d => cleanHora(d.hora));
  }

  function setChart(chart, labels, data){
    chart.data.labels = labels;
    chart.data.datasets[0].data = data;
    chart.update();
  }

  async function fetchJSON(url){
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  }

  // ========= REFRESH =========
  async function refresh(){
    try{
      // Traemos ambos devices
      const [s2, w] = await Promise.all([
        fetchJSON(API_S2),
        fetchJSON(API_WROOM),
      ]);

      // Count total (suma)
      document.getElementById("count").textContent = (s2.length + w.length);

      // --- S2 ---
      sortChronoAsc(s2);
      const s2view = s2.slice(-MAX_POINTS);
      const labS2 = labelsFrom(s2view);

      setChart(chTemp, labS2, s2view.map(d => clampNumber(d.temperatura)));
      setChart(chVolt, labS2, s2view.map(d => clampNumber(d.voltaje)));
      setChart(chCorr, labS2, s2view.map(d => clampNumber(d.corriente)));
      setChart(chPot,  labS2, s2view.map(d => clampNumber(d.potencia)));
      setChart(chRad,  labS2, s2view.map(d => clampNumber(d.radiometro)));

      // --- WROOM ---
      sortChronoAsc(w);
      const wview = w.slice(-MAX_POINTS);
      const labW = labelsFrom(wview);

      setChart(chV1, labW, wview.map(d => clampNumber(d.voltaje1)));
      setChart(chC1, labW, wview.map(d => clampNumber(d.corriente1)));
      setChart(chP1, labW, wview.map(d => clampNumber(d.potencia1)));

      setChart(chV2, labW, wview.map(d => clampNumber(d.voltaje2)));
      setChart(chC2, labW, wview.map(d => clampNumber(d.corriente2)));
      setChart(chP2, labW, wview.map(d => clampNumber(d.potencia2)));

      setChart(chV3, labW, wview.map(d => clampNumber(d.voltaje3)));
      setChart(chC3, labW, wview.map(d => clampNumber(d.corriente3)));
      setChart(chP3, labW, wview.map(d => clampNumber(d.potencia3)));

    } catch(e){
      console.log("refresh error:", e);
    }
  }

  // ========= CSV (1 botÃ³n) =========
  document.getElementById("btnCSV").addEventListener("click", () => {
    // descarga directa desde servidor (CSV ya viene limpio y ordenado)
    window.location.href = CSV_URL;
  });

  // ========= START =========
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
